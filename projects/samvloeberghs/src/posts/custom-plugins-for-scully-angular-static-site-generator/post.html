<section class="entry-content post-body" itemprop="articleBody">

  <h2>Scully - a Static Site Generator for Angular series</h2>

  <p>
    This article is part of <em>a growing series around Scully - a Static Site Generator for Angular</em>.
    If you get excited about this article be sure to check the others!
  </p>

  <ol>
    <li>
      Custom plugins for Scully - Angular Static Site Generator
    </li>
    <li>
      (<strong>Work in progress</strong>) Scully or Angular Universal, what is the difference?
    </li>
  </ol>

  <h2>Target audience</h2>

  <p>
    <a href="https://github.com/scullyio/scully" target="_blank" rel="noopener">Scully, the Static Site Generator for
      Angular</a>, comes with a plugin system that allows us to control which pages to prerender of our Angular
    application and how to prerender them. In this article we will <em>learn how to setup custom plugins</em> for your
    own specific usecases. If you care about the performance of your Angular application or website, please continue
    reading.
  </p>

  <h2>What is Scully?</h2>

  <p>
    Scully is basically <em>a static site generator, or SSG, for Angular</em>. It takes your full-blown Angular
    application and transforms the stable state of all the publicly available pages into their static HTML snapshot.
    You can deploy these HTML pages to a static webserver, with or without the original Angular application, and your
    application will load instantly. <em>Even without JS enabled</em>, because all the content is available in the
    original HTML returned from the server.
  </p>

  <p>
    This has some important consequences and benefits. The most important one is that <em>the content of your page is
    available instantly</em>. After your HTML page has loaded, the application can still bootstrap as the Angular app, giving you
    the full SPA functionality. But meanwhile the user will not be blocked to read or use the page until the Angular app
    has started up.
  </p>

  <h3>Getting started with Scully</h3>

  <p>
    Getting started with Scully is easy. The
    <a href="https://github.com/scullyio/scully/blob/master/docs/getting-started.md" target="_blank" rel="noopener">
      documentation on the Github project</a> will get you going setting up your first project. At the bottom of the
    article you can find more links and recources about setting up Scully.
  </p>

  <h3>Support for plugins</h3>

  <p>
    Scully is able to generate your pages because of a discovery process that finds the available routes of your
    application by scanning all the routing modules. Some routes are easy to discover, like for example the
    <code>/about</code> route. But other routes, for example dynamic routes like <code>/blog/:slug</code>, need to be
    listed based on known data, coming from for example a DB or API interface.
  </p>

  <p>
    The lists of available pages for these dynamic routes are built using plugins. There are two types of plugins
    available, <em>router plugins</em> and <em>renderer plugins</em>. As an example, Scully has a built-in
    router plugin of type <code>RouteTypes.json</code> that will load a JSON list and use the items in the list as a
    source for the available pages.
  </p>

  <h4 class="codetitle">scully.config.js</h4>
  <pre data-line="8-14"><code class="language-js line-numbers">const {
  RouteTypes,
} = require('@scullyio/scully');

exports.config = {
  projectRoot: './src/app',
  routes: {
    '/user/:userId': {
      type: RouteTypes.json,
      userId: {
        url: 'https://jsonplaceholder.typicode.com/users',
        property: 'id',
      }
    }
  }
}
</code></pre>

  <p>
    If we consider that our JSON source <code><a target="_blank" rel="noopener"
                                                    href="https://jsonplaceholder.typicode.com/users">
    https://jsonplaceholder.typicode.com/users</a></code> has around 10 users, this plugin
    will add 10 routes to the list of pages to prerender using our Angular application and Scully. Scully keeps track
    of the complete list to prerender in the <code>/src/assets/scully-routes.json</code> file.
  </p>

  <h4 class="codetitle">/src/assets/scully-routes.json</h4>
  <pre><code class="language-json line-numbers">[
  {"route": "/"}, {"route": "/about"},
  ...
  {"route": "/users/1"},
  {"route": "/users/2"},
  ...
  {"route": "/user/10"}
]</code></pre>

  <p>
    The next step is building our own plugins, but let's first shine some light on the example project we will use to
    explain the details and decide which plugins we need to build.
  </p>

  <h2>Example project</h2>

  <p>
    The example project is a simple Angular application with a few static routes, like <code>/about</code> and dynamic
    routes like <code>/news</code> that lists the available newsitems and <code>/news/:id/:slug</code> that shows the
    detail of a newsitem. The list of newsitems is retrieved from a static resource <code>/assets/news.json</code> and
    the newsdetail is available at <code>/assets/news/{id}.json</code>.
  </p>

  <img class="extraspace zoomin"
       src="/posts/custom-plugins-for-scully-angular-static-site-generator/example_app.gif"
       alt=""/>

  <p>
    Based on the data of <code>/assets/news.json</code> the list of all routes for our example application looks like
    the list below. Remember, Scully is generating the complete list.
  </p>

  <h4 class="codetitle">/src/assets/scully-routes.json</h4>
  <pre><code class="language-json line-numbers">[
  {"route":"/"},
  {"route":"/about"},
  {"route":"/news"},
  {"route":"/news/archive"},
  {"route":"/news/1/newsitem-1"},
  {"route":"/news/2/newsitem-2"},
  {"route":"/news/5/newsitem-5"},
  {"route":"/news/99/newsitem-99"}
]</code></pre>

  <h2>Custom router plugin</h2>

  <p>
    To be able to generate the list of pages for our news module, that has detail pages in the form of
    <code>news/:id/:slug</code> with 2 parameters <code>:id</code> and <code>:slug</code>, we need to program a custom
    router plugin for Scully. A router plugin is easy, you just need to write some code that will generate a list of
    routes, based on a given configuration. Let's break down the code from our <code>newsPlugin</code>:
  </p>

  <h4 class="codetitle">/plugins/newsPlugin.js</h4>
  <pre data-line="6,7,15,18-19"><code class="language-js line-numbers">const {registerPlugin, configValidator, routeSplit} = require('@scullyio/scully');
const {httpGetJson} = require('@scullyio/scully/utils/httpGetJson');

const NewsPlugin = 'news';

const newsPlugin = async(route, config) => {
  const {createPath} = routeSplit(route);
  const list = await httpGetJson(config.url);
  const handledRoutes = [];
  for (let item of list) {
    handledRoutes.push({
      route: createPath(item.id, item.slug)
    });
  }
  return handledRoutes;
};

registerPlugin('router', 'news', newsPlugin);
exports.NewsPlugin = NewsPlugin;
</code></pre>

  <ol>
    <li>
      The plugin function, defined at line 6, is an async function that expects the <code>route</code> we are handling,
      in this case the <code>news/:id/:slug</code> route. A <code>config</code> object as the second parameter, that is
      tight to the route, contains all the information we need to generate the list urls. In this case we only need a
      url.
    </li>
    <li>
      At line 8 we generate a <code>createPath</code> function based on the given route. This function will be used to
      build the final page url, based on the JSON data we retrieved from the <code>url</code> defined in the config
      object and the original route.
    </li>
    <li>
      The code that follows in the async function is the actual implementation generating all the urls available for
      this route.
    </li>
    <li>
      Finally, we register the plugin to make it available for Scully. The first parameter defines the type of plugin,
      the second parameter marks the name of the plugin. We also export the NewsPlugin as a type.
    </li>
  </ol>

  <h3>Configuring the new plugin</h3>

  <p>
    Configuring the new router plugin is easy! In our Scully configuration object, we define our route at line 8-11 and
    we give it the type of our newsPlugin. The only configuration we needed for our custom plugin was the
    <code>url</code> to fetch the JSON data from, and we are done!
  </p>

  <h4 class="codetitle">scully.config.js</h4>
  <pre data-line="8-11"><code class="language-js line-numbers">const {RouteTypes} = require('@scullyio/scully');

const {News} = require('./plugins/newsPlugin');

exports.config = {
  projectRoot: './src/app',
  routes: {
    '/news/:id/:slug': {
      type: News,
      url: 'http://localhost:4200/assets/news.json',
    },
  }
};
</code></pre>

  <p>
    When running Scully with <code>npm run scully</code> the new router plugin is used and the generated output will be
    a set of available pages with news details:
  </p>

  <h4 class="codetitle">/src/assets/scully-routes.json</h4>
  <pre><code class="language-json line-numbers">[
    ...
    {"route":"/news"},
    {"route":"/news/archive"},
    {"route":"/news/1/newsitem-1"},
    {"route":"/news/2/newsitem-2"},
    {"route":"/news/5/newsitem-5"},
    {"route":"/news/99/newsitem-99"}
]</code></pre>

  <h2>Custom renderer plugin</h2>

  <p>
    Custom renderer plugins can be used to perform some sort of modification on the generated HTML as
    <code>postRenderers</code>. These <code>postRenderers</code> can be defined as a default, for all rendered pages,
    or defined on the level of each route. In the latter case, these <code>postRenderers</code> will only be executed
    on the pages generated for that specific route.
  </p>

  <p>
    A typical thing to do after generating the static HTML of our pages is to minify the HTML. By removing unnecessary
    code we can make our pages smaller and faster, which will result in more performant loading times. We can easily
    minify the HTML by defining a <code>minifyHtml</code> renderer plugin.
  </p>

  <h4 class="codetitle">/plugins/minifyHtmlPlugin.js</h4>
  <pre data-line="6-19,21-24,26-27"><code class="language-js line-numbers">const {registerPlugin, configValidator} = require('@scullyio/scully');
const minify = require('html-minifier').minify;

const MinifyHtml = 'minifyHtml';

const minifyOptions = {
  removeComments: true,
  removeCommentsFromCDATA: true,
  collapseWhitespace: true,
  collapseBooleanAttributes: true,
  removeRedundantAttributes: true,
  useShortDoctype: true,
  removeEmptyAttributes: true,
  minifyCSS: true,
  // don't remove attribute quotes, not all social media platforms can parse this over-optimization
  removeAttributeQuotes: false,
  // don't remove optional tags, like the head, not all social media platforms can parse this over-optimization
  removeOptionalTags: false,
};

const minifyHtmlPlugin = async (html, route) => {
  const minifiedHtml = minify(html, minifyOptions);
  return Promise.resolve(minifiedHtml);
};

registerPlugin('render', 'minifyHtml', minifyHtmlPlugin);
exports.MinifyHtml = MinifyHtml;</code></pre>

  <ol>
    <li>
      The first object you see, line 6-19, is the configuration object we use for the
      <a href="https://www.npmjs.com/package/html-minifier" target="_blank" rel="noopener">HTML minifier</a>. This is
      the same minifier I used explaining
      <a href="posts/creating-a-simple-memory-cache-for-your-angular-universal-website-or-application">how to setup a
        simple memory cache for Angular Universal</a>
    </li>
    <li>
      Just as with the custom router plugin for we define an async function. This function takes the HTML and
      associated route as input. In our case we don't need the route, we just transform the HTML by minifying it and
      return it as resolved Promise.
    </li>
    <li>
      Finally, we register the plugin to make it available for Scully. The first parameter defines the type of plugin,
      the second parameter marks the name of the plugin. We also export the MinifyHtml as a type.
    </li>
  </ol>

  <h3>Configuring the new plugin</h3>

  <p>
    Configuring the new renderer plugin is, again, easy! In our Scully configuration object, we can define a list of
    <code>postRenderers</code> as a default for all routes using the <code>defaultPostRenderers</code> option. By
    configuring Scully like this every page that gets statically generated will be minified.
  </p>

  <p>
    Just keep in mind that if you define a route configuration, the same postRenderers need to be attached to the route
    configuration using <code>postRenderers</code>. The <code>defaultPostRenderers</code> will not be executed in these
    cases.
  </p>

    <h4 class="codetitle">scully.config.js</h4>
  <pre data-line="8-11,15"><code class="language-js line-numbers">const {RouteTypes} = require('@scullyio/scully');

const {MinifyHtml} = require('./plugins/minifyHtmlPlugin');
const {News} = require('./plugins/newsPlugin');

const postRenderers = [MinifyHtml];

exports.config = {
  projectRoot: './src/app',
  defaultPostRenderers: postRenderers,
  routes: {
    '/news/:id/:slug': {
      type: News,
      url: 'http://localhost:4200/assets/news.json',
      postRenderers: postRenderers,
    }
  }
};
</code></pre>

  <p>
    Running Scully with <code>npm run scully</code> will now not only generate the correct newsdetail pages, it will
    also minify the HTML of the generated pages:
  </p>

  <img class="extraspace zoomin"
       src="/posts/custom-plugins-for-scully-angular-static-site-generator/minified_html.gif"
       alt=""/>

  <h2>Using the <code>scully-minify-html</code> plugin</h2>

  <p>
    Because it is a plugin and we can share code via npm it would be silly to rewrite the minify html plugin, except
    for learning purposes ofcourse. Installing it is as easy as running
    <code><a href="http://npmjs.com/package/scully-minify-html" target="_blank" rel="noopener">
      npm i -s scully-minify-html</a></code> in your Angular project. This will install the plugin for you. The only
    thing left is to configure it in your <code>scully.config.js</code> file as follows:
  </p>

  <h4 class="codetitle">scully.config.js</h4>
  <pre data-line="2,4,9,13,18"><code class="language-js line-numbers">const {RouteTypes, registerPlugin} = require('@scullyio/scully');
const {MinifyHtml, minifyHtmlPluginFactory} = require('scully-minify-html');

registerPlugin('render', MinifyHtml, minifyHtmlPluginFactory({}));

// custom plugins in ./plugins/*.js
const {News} = require('./plugins/newsPlugin');

const postRenderers = [MinifyHtml];

exports.config = {
  projectRoot: './src/app',
  defaultPostRenderers: postRenderers,
  routes: {
    '/news/:id/:slug': {
      type: News,
      url: 'http://localhost:4200/assets/news.json',
      postRenderers: postRenderers,
    }
  }
};
</code></pre>

  <p>
    Let's breakdown the code into little steps explaining what is going on:
  </p>

  <ol>
    <li>
      First of all we import the required code from our freshly installed Scully plugin. We need the plugin itself,
      called <code>minifyHtmlPluginFactory</code> and the type <code>MinifyHtml</code>we will associate with the plugin.
    </li>
    <li>
      At line 4 we register the plugin, keeping in mind that this is a factory function! We can use the function to pass
      details, like a configurating object for the
      <code><a href="https://www.npmjs.com/package/html-minifier" target="_blank" rel="noopener">html-minifier plugin
      </a></code>
    </li>
    <li></li>
    <li></li>
  </ol>

  <h2 id="conclusion">Conclusion</h2>

  <p></p>

  <h2>Further reading</h2>

  <ol class="further-reading">
    <li>
      <a href="https://github.com/scullyio" target="_blank" rel="noopener">
        Scully - Github organization
      </a>
    </li>
    <li>
      <a href="https://www.youtube.com/watch?v=BRWKiF0Zkgs" target="_blank" rel="noopener">
        Scully - live code introduction on Youtube
      </a>
    </li>
    <li>
      <a href="https://medium.com/angular-in-depth/scully-the-static-site-generator-for-angular-d0608cb028ae" target="_blank" rel="noopener">
        Scully, the First Static Site Generator for Angular
      </a>
    </li>
    <li>
      <a href="https://www.learnwithjason.dev/create-a-static-site-using-angular-scully" target="_blank" rel="noopener">
        Create a Static Site Using Angular & Scully
      </a>
    </li>
  </ol>

  <!--
  <h2>Special thanks to</h2>

  <ul>
    <li>
      <a href="" rel="noopener" target="_blank"></a>
    </li>

  </ul>

  <p>for reviewing this post and providing valuable and much-appreciated feedback!</p>
  -->
</section>
